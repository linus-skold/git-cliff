name: 'Patched Release Build'

on:
  push:
    branches:
      - 'use-patched-*' 
  workflow_dispatch:  # Allow manual triggering
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string

env:
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUST_BACKTRACE: short
  RUSTUP_MAX_RETRIES: 10

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ${{ matrix.build.os }}
    strategy:
      matrix:
        build:
          - {
              NAME: linux-x64-glibc,
              OS: ubuntu-22.04,
              TOOLCHAIN: stable,
              TARGET: x86_64-unknown-linux-gnu,
            }
          - {
              NAME: linux-arm64-glibc,
              OS: ubuntu-22.04,
              TOOLCHAIN: stable,
              TARGET: aarch64-unknown-linux-gnu,
            }
          - {
              NAME: win32-x64-msvc,
              OS: windows-2022,
              TOOLCHAIN: stable,
              TARGET: x86_64-pc-windows-msvc,
            }
          - {
              NAME: darwin-x64,
              OS: macos-13,
              TOOLCHAIN: stable,
              TARGET: x86_64-apple-darwin,
            }
          - {
              NAME: darwin-arm64,
              OS: macos-14,
              TOOLCHAIN: stable,
              TARGET: aarch64-apple-darwin,
            }
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Set release version
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "RELEASE_VERSION=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "RELEASE_VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          else
            # For branch builds, create a pre-release version
            COMMIT_SHA=$(git rev-parse --short HEAD)
            BRANCH_NAME=${GITHUB_REF#refs/heads/}
            echo "RELEASE_VERSION=${BRANCH_NAME}-${COMMIT_SHA}" >> $GITHUB_ENV
          fi

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ matrix.build.TOOLCHAIN }}
          target: ${{ matrix.build.TARGET }}
          override: true
          default: true

      - name: Build (Linux/macOS)
        if: matrix.build.OS != 'windows-2022'
        uses: actions-rs/cargo@v1
        with:
          use-cross: true
          command: build
          args: --release --target ${{ matrix.build.TARGET }}

      - name: Build (Windows)
        if: matrix.build.OS == 'windows-2022'
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --target ${{ matrix.build.TARGET }}

      - name: Prepare release files
        shell: bash
        run: |
          mkdir -p release
          cp {LICENSE-MIT,LICENSE-APACHE,README.md,CHANGELOG.md} release/ 2>/dev/null || true
          
          bin="git-cliff"
          if [ "${{ matrix.build.OS }}" = "windows-2022" ]; then
            bin="${bin}.exe"
          fi
          cp "target/${{ matrix.build.TARGET }}/release/${bin}" release/
          
          mv release/ git-cliff-${{ env.RELEASE_VERSION }}/

      - name: Create release archive
        shell: bash
        run: |
          if [ "${{ matrix.build.OS }}" = "windows-2022" ]; then
            7z a -tzip "git-cliff-${{ env.RELEASE_VERSION }}-${{ matrix.build.TARGET }}.zip" \
              git-cliff-${{ env.RELEASE_VERSION }}/
          else
            tar -czvf git-cliff-${{ env.RELEASE_VERSION }}-${{ matrix.build.TARGET }}.tar.gz \
              git-cliff-${{ env.RELEASE_VERSION }}/
          fi

      - name: Create GitHub Release (Manual or Branch)
        if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/'))
        uses: softprops/action-gh-release@v1
        with:
          files: git-cliff-${{ env.RELEASE_VERSION }}-${{ matrix.build.TARGET }}.*
          tag_name: ${{ env.RELEASE_VERSION }}
          name: "Patched Build ${{ env.RELEASE_VERSION }}"
          draft: false
          prerelease: true
          generate_release_notes: true
          target_commitish: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: git-cliff-${{ matrix.build.TARGET }}
          path: git-cliff-${{ env.RELEASE_VERSION }}-${{ matrix.build.TARGET }}.*